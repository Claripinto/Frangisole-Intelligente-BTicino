blueprint:
  name: Frangisole Intelligente BTicino
  description: >
    Automazione avanzata per la gestione intelligente dei frangisole BTicino,
    con calcolo solare (azimut, elevazione, FOV), privacy dinamica,
    tilt-up e tilt-down configurabili, compatibilitÃ  con sensori meteo,
    controllo climatico opzionale, gestione porta aperta, override manuale
    e funzioni di sicurezza.

    Blueprint migliorato da Orazio.

  domain: automation
  source_url: "https://github.com/oraziopata/frangisole_intelligente_bticino"

###########################################
#   B L O C C O   1 :   I N P U T S       #
###########################################

input:

  cover_entity:
    name: Frangisole da controllare
    description: >
      Seleziona uno o piÃ¹ frangisole BTicino compatibili.
      Puoi inserirne piÃ¹ di uno per gestire intere facciate.
    selector:
      target:
        entity:
          domain: cover

  #########################################################
  #    GEOMETRIA FINESTRA / CALCOLO SOLE
  #########################################################

  azimut:
    name: Azimut Finestra
    description: >
      Orientamento della finestra/frangisole.
      0Â° = Nord, 90Â° = Est, 180Â° = Sud, 270Â° = Ovest.
    default: 180
    selector:
      number:
        min: 0
        max: 359
        step: 1
        mode: slider

  distance:
    name: Distanza finestra â†’ zona ombra (metri)
    description: >
      Distanza orizzontale fra il frangisole e il punto del pavimento
      dove vuoi calcolare l'ombra.
    default: 0.5
    selector:
      number:
        min: 0.1
        max: 3.0
        step: 0.1
        unit_of_measurement: m

  max_height:
    name: Altezza massima frangisole (metri)
    description: >
      Altezza totale del frangisole quando Ã¨ completamente abbassato.
    default: 2.1
    selector:
      number:
        min: 0.5
        max: 4.0
        step: 0.1
        unit_of_measurement: m

  default_position:
    name: Posizione predefinita fuori dal FOV (%)
    description: >
      Posizione del frangisole quando il sole non Ã¨ nel campo visivo.
    default: 60
    selector:
      number:
        min: 0
        max: 100
        step: 1
        unit_of_measurement: "%"

  min_position:
    name: Posizione minima consentita (%)
    description: >
      Il frangisole non andrÃ  mai sotto questa posizione,
      qualunque sia il calcolo solare o la privacy.
    default: 1
    selector:
      number:
        min: 0
        max: 100
        step: 1

  fov:
    name: FOV Totale (gradi)
    description: >
      Ampiezza totale del campo visivo della finestra.
      Esempio: 90 significa 45Â° a sinistra e 45Â° a destra.
    default: 90
    selector:
      number:
        min: 10
        max: 120
        step: 1

  fov_left:
    name: FOV sinistra (gradi)
    description: >
      Ampiezza campo visivo lato sinistra.
      Usalo se la finestra ha ostruzioni asimmetriche.
    default: 45
    selector:
      number:
        min: 0
        max: 120
        step: 1

  fov_right:
    name: FOV destra (gradi)
    description: >
      Ampiezza campo visivo lato destra.
    default: 45
    selector:
      number:
        min: 0
        max: 120
        step: 1

  min_elevation:
    name: Elevazione minima sole (Â°)
    description: >
      Al di sotto di questa elevazione il sole non viene considerato.
    default: 0
    selector:
      number:
        min: 0
        max: 45
        step: 1

  max_elevation:
    name: Elevazione massima sole (Â°)
    description: >
      Al di sopra di questa elevazione il frangisole non reagirÃ .
    default: 45
    selector:
      number:
        min: 10
        max: 90
        step: 1

  change_threshold:
    name: Soglia di variazione (%)
    description: >
      Il frangisole si muoverÃ  solo se la differenza tra posizione attuale
      e target supera questa percentuale (protezione motori).
    default: 1
    selector:
      number:
        min: 1
        max: 20
        step: 1

  cooldown_minutes:
    name: Tempo minimo tra movimenti (min)
    description: >
      Protezione motori: attesa minima tra un movimento e quello successivo.
    default: 1
    selector:
      number:
        min: 0
        max: 30
        step: 1

  #########################################################
  #               PRIVACY
  #########################################################

  privacy_mode:
    name: ModalitÃ  Privacy
    description: >
      â€¢ always: sempre garantita  
      â€¢ sun_in_fov: solo quando il sole Ã¨ nella finestra  
      â€¢ below_threshold: solo se il calcolo solare Ã¨ basso  
      â€¢ off: nessuna privacy
    default: "below_threshold"
    selector:
      select:
        options:
          - "always"
          - "sun_in_fov"
          - "below_threshold"
          - "off"

  privacy_min_position:
    name: Posizione minima per privacy (%)
    description: >
      La posizione minima garantita quando la privacy si attiva.
    default: 1
    selector:
      number:
        min: 0
        max: 100
        step: 1

  privacy_threshold:
    name: Soglia privacy (%)
    description: >
      Se privacy_mode = below_threshold,
      la privacy scatta solo quando il calcolo posizione < questa soglia.
    default: 20
    selector:
      number:
        min: 0
        max: 100
        step: 1

  #########################################################
  #           TILT-UP (chiudi â†’ apri 1â€“5%)
  #########################################################

  tilt_up_enabled:
    name: Abilita Tilt-Up automatico
    default: true
    selector:
      boolean: {}

  tilt_up_position:
    name: Posizione dopo Tilt-Up (%)  
    description: >
      La posizione finale dopo chiusura+riapertura.
      Tipicamente 1â€“5% per inclinare le lamelle.
    default: 1
    selector:
      number:
        min: 0
        max: 10
        step: 1

  tilt_up_apply_when_below:
    name: Applica Tilt-Up se target sotto (%)
    description: >
      Il tilt-up scatta solo se il target Ã¨ sotto a questa percentuale.
    default: 20
    selector:
      number:
        min: 0
        max: 100
        step: 1

  tilt_up_reset_delay:
    name: Ritardo prima di applicare il Tilt-Up (sec)
    description: >
      Tempo in secondi tra il movimento principale e il tilt-up.
    default: 3
    selector:
      number:
        min: 0
        max: 15
        step: 1

  #########################################################
  #           TILT-DOWN (oscura leggermente)
  #########################################################

  tilt_down_enabled:
    name: Abilita Tilt-Down
    default: false
    selector:
      boolean: {}

  tilt_down_offset:
    name: Offset Tilt-Down (%)
    description: >
      Il target viene abbassato di X% per far chiudere leggermente le lamelle.
    default: 2
    selector:
      number:
        min: 0
        max: 20
        step: 1

  #########################################################
  #            CLIMATICA (pioggia/vento/porta)
  #########################################################

  climate_enabled:
    name: Abilita funzioni climatiche
    default: false
    selector:
      boolean: {}

  rain_sensor:
    name: Sensore pioggia
    description: >
      Attiva comportamento speciale in caso di pioggia.
    default: null
    selector:
      entity:
        domain: binary_sensor

  rain_action:
    name: Azione in caso di pioggia
    default: "close"
    selector:
      select:
        options:
          - "close"
          - "open"
          - "ignore"

  wind_sensor:
    name: Sensore vento (velocitÃ )
    default: null
    selector:
      entity:
        domain: sensor

  wind_threshold:
    name: Soglia vento (km/h)
    default: 30
    selector:
      number:
        min: 5
        max: 200
        step: 1

  door_sensor:
    name: Sensore porta (aperta/chiusa)
    default: null
    selector:
      entity:
        domain: binary_sensor

  door_behavior:
    name: Comportamento porta aperta
    default: "ignore"
    selector:
      select:
        options:
          - "ignore"
          - "open_full"
          - "close_full"

  #########################################################
  #            TEMPERATURA / PRESENZA / OVERRIDE
  #########################################################

  temp_sensor_inside:
    name: Sensore temperatura interna
    default: null
    selector:
      entity:
        domain: sensor

  temp_hot_threshold:
    name: Soglia caldo interno (Â°C)
    default: 27
    selector:
      number:
        min: 10
        max: 40
        step: 0.5

  temp_cold_threshold:
    name: Soglia freddo interno (Â°C)
    default: 18
    selector:
      number:
        min: 5
        max: 30
        step: 0.5

  presence_sensor:
    name: Sensore presenza
    default: null
    selector:
      entity:
        domain: binary_sensor

  presence_timeout:
    name: Timeout presenza (minuti)
    default: 30
    selector:
      number:
        min: 0
        max: 120
        step: 1

  manual_override_entity:
    name: Interruttore override manuale
    description: >
      Se acceso, blocca completamente il controllo automatico
      e il frangisole resta alla posizione manualmente impostata.
    default: null
    selector:
      entity:
        domain: input_boolean

  override_time:
    name: Durata override automatico (minuti)
    description: >
      Se l'automazione imposta l'override,
      quanto tempo deve restare attivo?
    default: 15
    selector:
      number:
        min: 1
        max: 180
        step: 1

  #########################################################
  #                  DEBUG
  #########################################################

  debug:
    name: Debug (log avanzato)
    default: false
    selector:
      boolean: {}

###########################################
#   B L O C C O   2 :   V A R I A B I L I  #
###########################################

variables:

  cover: !input cover_entity
  azimut: !input azimut
  fov: !input fov
  fov_left: !input fov_left
  fov_right: !input fov_right
  distance: !input distance
  max_height: !input max_height
  default_position: !input default_position
  min_position: !input min_position
  min_elevation: !input min_elevation
  max_elevation: !input max_elevation
  change_threshold: !input change_threshold
  cooldown_minutes: !input cooldown_minutes

  privacy_mode: !input privacy_mode
  privacy_min_position: !input privacy_min_position
  privacy_threshold: !input privacy_threshold

  tilt_up_enabled: !input tilt_up_enabled
  tilt_up_position: !input tilt_up_position
  tilt_up_apply_when_below: !input tilt_up_apply_when_below
  tilt_up_reset_delay: !input tilt_up_reset_delay

  tilt_down_enabled: !input tilt_down_enabled
  tilt_down_offset: !input tilt_down_offset

  climate_enabled: !input climate_enabled
  rain_sensor: !input rain_sensor
  rain_action: !input rain_action
  wind_sensor: !input wind_sensor
  wind_threshold: !input wind_threshold
  temp_sensor_inside: !input temp_sensor_inside
  temp_hot_threshold: !input temp_hot_threshold
  temp_cold_threshold: !input temp_cold_threshold
  presence_sensor: !input presence_sensor
  presence_timeout: !input presence_timeout
  door_sensor: !input door_sensor
  door_behavior: !input door_behavior

  manual_override: !input manual_override_entity
  override_time: !input override_time

  debug: !input debug

  #######################################
  #   CALCOLO POSIZIONE SOLE            #
  #######################################
  sun_azimuth: "{{ state_attr('sun.sun', 'azimuth') }}"
  sun_elevation: "{{ state_attr('sun.sun', 'elevation') }}"

  gamma_rad: >
    {% set a = (azimut - sun_azimuth + 180) % 360 - 180 %}
    {{ a * pi / 180 }}

  fov_left_rad: "{{ (fov_left * pi / 180) }}"
  fov_right_rad: "{{ (fov_right * pi / 180) }}"
  elev_min_rad: "{{ (min_elevation * pi / 180) }}"
  elev_max_rad: "{{ (max_elevation * pi / 180) }}"
  sun_elev_rad: "{{ sun_elevation * pi / 180 }}"

  #######################################
  #   SOLE DENTRO FOV? (TRUE/FALSE)     #
  #######################################
  sun_in_fov: >
    {{ gamma_rad >= -fov_left_rad and gamma_rad <= fov_right_rad
       and sun_elev_rad >= elev_min_rad
       and sun_elev_rad <= elev_max_rad }}

  #######################################
  #    CALCOLO OMBRA SU PAVIMENTO       #
  #######################################
  sun_height_m: >
    {% if (sun_elev_rad | float) <= 0 %}
      9999
    {% else %}
      {{ distance / (tan(sun_elev_rad)) }}
    {% endif %}

  position_calc_raw: >
    {% set perc = (sun_height_m / max_height) * 100 %}
    {% if perc < 0 %} 0
    {% elif perc > 100 %} 100
    {% else %} {{ perc }}
    {% endif %}

  #######################################
  #      PRIVACY COMPUTATION            #
  #######################################
  position_after_privacy: >
    {% set p = position_calc_raw | float %}
    {% if privacy_mode == "always" %}
      {{ max(p, privacy_min_position) }}
    {% elif privacy_mode == "sun_in_fov" %}
      {% if sun_in_fov %}
        {{ max(p, privacy_min_position) }}
      {% else %}
        {{ p }}
      {% endif %}
    {% elif privacy_mode == "below_threshold" %}
      {% if p < privacy_threshold %}
        {{ max(p, privacy_min_position) }}
      {% else %}
        {{ p }}
      {% endif %}
    {% else %}
      {{ p }}
    {% endif %}

  #######################################
  #          TILT-DOWN OFFSET           #
  #######################################
  position_after_tilt_down: >
    {% set p = position_after_privacy | float %}
    {% if tilt_down_enabled %}
      {{ max(0, p - tilt_down_offset) }}
    {% else %}
      {{ p }}
    {% endif %}

  #######################################
  #     POSIZIONE FINALE PRELIMINARE    #
  #######################################
  position_target_pre: >
    {% if sun_in_fov %}
      {{ position_after_tilt_down }}
    {% else %}
      {{ default_position }}
    {% endif %}

  #######################################
  #   APPLICO POSIZIONE MINIMA ASSOLUTA #
  #######################################
  position_target: >
    {% set p = position_target_pre | float %}
    {% if p < min_position %}
      {{ min_position }}
    {% else %}
      {{ p }}
    {% endif %}

###########################################
#   B L O C C O   3 :  T R I G G E R      #
###########################################

trigger:
  - platform: state
    entity_id: sun.sun

  - platform: time_pattern
    minutes: "/1"   # backup ogni minuto

###########################################
#   B L O C C O   4 :  C O N D I T I O N #
###########################################

condition:

  # Se override manuale Ã¨ attivo â†’ STOP
  - condition: template
    value_template: >
      {% if manual_override %}
        {{ is_state(manual_override, 'off') }}
      {% else %}
        true
      {% endif %}

  # Cooldown (evita stress motori)
  - condition: template
    value_template: >
      {% set last = states[cover.entity_id].last_changed %}
      {{ (now() - last).total_seconds() / 60 >= cooldown_minutes }}
###########################################
#   B L O C C O   5 :   A Z I O N I       #
###########################################

action:

  ##################################
  # 1) DEBUG : STAMPA VALORI       #
  ##################################
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ debug }}"
        sequence:
          - service: system_log.write
            data:
              message: >
                [FRANGISOLE DEBUG]  
                Sole in FOV: {{ sun_in_fov }}  
                Elevazione: {{ sun_elevation }}  
                Azimut: {{ sun_azimuth }}  
                Calcolo ombra: {{ position_calc_raw }}%  
                Privacy â†’ {{ position_after_privacy }}%  
                Tilt-down â†’ {{ position_after_tilt_down }}%  
                Target finale â†’ {{ position_target }}%
              level: info


  ##################################
  # 2) LOGICA CLIMATICA BASE       #
  ##################################

  - choose:

      ##########################################################
      # â˜” PIOGGIA â€” solo se abilitato
      ##########################################################
      - conditions:
          - condition: template
            value_template: "{{ climate_enabled and rain_sensor != none }}"
          - condition: state
            entity_id: !input rain_sensor
            state: "on"
        sequence:

          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: >
                {% if rain_action == "close" %} 0
                {% elif rain_action == "open" %} 100
                {% else %} {{ position_target }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: "[FRANGISOLE] Rain mode attivato"
                      level: info

          - stop


      ##########################################################
      # ðŸ’¨ VENTO â€” se supera la soglia (protezione frangisole)
      ##########################################################
      - conditions:
          - condition: template
            value_template: "{{ climate_enabled and wind_sensor != none }}"
          - condition: template
            value_template: >
              {{ states(wind_sensor)|float(0) >= wind_threshold }}
        sequence:
          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: 100   # tutto aperto = sicuro

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: "[FRANGISOLE] Wind mode attivato"
                      level: warning

          - stop


      ##########################################################
      # ðŸšª PORTA APERTA (se configurato)
      ##########################################################
      - conditions:
          - condition: template
            value_template: "{{ climate_enabled and door_sensor != none }}"
          - condition: state
            entity_id: !input door_sensor
            state: "on"
        sequence:

          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: >
                {% if door_behavior == "open_full" %} 100
                {% elif door_behavior == "close_full" %} 0
                {% else %} {{ position_target }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: "[FRANGISOLE] Door mode attivato"
                      level: info

          - stop


  ##################################
  # 3) MOVIMENTO PRINCIPALE        #
  ##################################

  - service: cover.set_cover_position
    target: !input cover_entity
    data:
      position: "{{ position_target | int }}"


  ##################################
  # 4) TILT-UP DOPO MOVIMENTO      #
  ##################################

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ tilt_up_enabled }}"
          - condition: template
            value_template: >
              {% set t = position_target|float %}
              {% set thr = tilt_up_apply_when_below|float %}
              {{ t <= thr }}
        sequence:

          - delay:
              seconds: "{{ tilt_up_reset_delay }}"

          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: "{{ tilt_up_position }}"   # â†’ 1â€“5% (INCLINAZIONE LAMELLE)

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: >
                        [FRANGISOLE] Tilt-UP applicato dopo movimento
                      level: info

###########################################
#   F I N E   B L U E P R I N T           #
###########################################

mode: restart
