blueprint:
  name: Frangisole Intelligente BTicino
  description: >
    Controllo avanzato per frangisole BTicino (attuatore K4672M2S o compatibili),
    con calcolo posizione in base al sole (azimut/elevazione), gestione privacy,
    modalitÃ  climatica, tilt virtuale (reset lamelle), offset tilt-down,
    logiche di sicurezza (vento/pioggia/porta), override manuale e debouncing.
    Pensato per essere istanziato per ogni singolo frangisole.
    Migliorato da Orazio.

  domain: automation

###########################################
#   B L O C C O   1 :   INPUT  U I        #
###########################################

input:

  ###########################################
  # 1. COPERTURA / FRANGISOLE TARGET        #
  ###########################################
  cover_entity:
    name: Frangisole (entitÃ )
    description: >
      Seleziona l'entitÃ  cover del frangisole controllato da questa istanza.
      Il blueprint Ã¨ pensato per essere usato uno per ogni frangisole.
    selector:
      entity:
        domain: cover

  ###########################################
  # 2. GEOMETRIA FINESTRA E SOLE           #
  ###########################################
  azimut:
    name: Azimut finestra
    description: >
      Orientamento della finestra in gradi:
      0 = Nord, 90 = Est, 180 = Sud, 270 = Ovest.
    default: 180
    selector:
      number:
        min: 0
        max: 359
        step: 1

  fov:
    name: Campo visivo totale
    description: >
      Ampiezza totale in gradi del campo visivo della finestra.
      Un valore tipico Ã¨ 90Â°.
    default: 90
    selector:
      number:
        min: 0
        max: 180
        step: 1

  fov_left:
    name: FOV sinistro
    description: >
      Ampiezza in gradi a sinistra dell'azimut della finestra.
      Usalo se il FOV non Ã¨ simmetrico. Tipicamente 90Â°.
    default: 90
    selector:
      number:
        min: 0
        max: 180
        step: 1

  fov_right:
    name: FOV destro
    description: >
      Ampiezza in gradi a destra dell'azimut della finestra.
      Usalo se il FOV non Ã¨ simmetrico. Tipicamente 90Â°.
    default: 90
    selector:
      number:
        min: 0
        max: 180
        step: 1

  distance:
    name: Distanza vetro â†’ zona d'ombra (m)
    description: >
      Distanza in metri tra il frangisole e il punto da ombreggiare.
      Serve per i calcoli trigonometrici della proiezione solare.
    default: 0.5
    selector:
      number:
        min: 0.1
        max: 5
        step: 0.1

  max_height:
    name: Altezza massima frangisole (m)
    description: >
      Altezza del vano finestra / frangisole in metri.
    default: 2.1
    selector:
      number:
        min: 0.5
        max: 5
        step: 0.1

  default_position:
    name: Posizione predefinita (%)
    description: >
      Posizione percentuale da assumere quando il sole NON Ã¨ nel campo visivo
      e non sono attive condizioni speciali.
    default: 60
    selector:
      number:
        min: 0
        max: 100
        step: 1

  min_position:
    name: Posizione minima consentita (%)
    description: >
      Limite inferiore assoluto. Impostalo se non vuoi che il frangisole
      scenda completamente a 0%.
    default: 0
    selector:
      number:
        min: 0
        max: 100
        step: 1

  min_elevation:
    name: Elevazione minima sole (Â°)
    description: >
      Soglia inferiore di elevazione solare per considerare il sole valido.
    default: 0
    selector:
      number:
        min: -90
        max: 90
        step: 1

  max_elevation:
    name: Elevazione massima sole (Â°)
    description: >
      Soglia superiore di elevazione solare per considerare il sole valido.
    default: 90
    selector:
      number:
        min: -90
        max: 90
        step: 1

  change_threshold:
    name: Soglia minima variazione (%)
    description: >
      Movimento ignorato se la differenza dalla posizione attuale Ã¨ minore
      di questa soglia. Serve per non stressare i motori.
    default: 1
    selector:
      number:
        min: 0
        max: 100
        step: 1

  cooldown_minutes:
    name: Cooldown tra movimenti (minuti)
    description: >
      Tempo minimo tra due movimenti consecutivi del frangisole.
    default: 2
    selector:
      number:
        min: 0
        max: 120
        step: 1

  ###########################################
  # 3. MODALITÃ€ PRIVACY                    #
  ###########################################
  privacy_mode:
    name: ModalitÃ  Privacy
    description: >
      Regole per applicare automaticamente una posizione minima di privacy.
      - always: sempre
      - below_threshold: quando la posizione calcolata Ã¨ sotto una soglia
      - sun_in_fov: solo quando il sole Ã¨ nel campo visivo
    default: always
    selector:
      select:
        options:
          - label: Sempre
            value: always
          - label: Solo se posizione < soglia
            value: below_threshold
          - label: Solo se sole nel FOV
            value: sun_in_fov

  privacy_min_position:
    name: Posizione minima privacy (%)
    description: >
      Posizione minima da garantire per la privacy (tipicamente 1%).
    default: 1
    selector:
      number:
        min: 0
        max: 10
        step: 1

  privacy_threshold:
    name: Soglia privacy (%)
    description: >
      Valida solo se privacy_mode == below_threshold.
      Se la posizione calcolata Ã¨ minore di questa, si applica privacy.
    default: 20
    selector:
      number:
        min: 1
        max: 50
        step: 1

  ###########################################
  # 4. TILT-UP (RESET LAMELLE)             #
  ###########################################
  tilt_up_enabled:
    name: Abilita Tilt-UP
    description: >
      Se attivo, prima chiude completamente il frangisole e poi risale
      per ottenere lamelle inclinate e luce naturale. Sequenza:
      chiudi â†’ attesa â†’ apri a tilt_up_position.
    default: true
    selector:
      boolean: {}

  tilt_up_position:
    name: Posizione Tilt-UP (%) (1â€“5)
    description: >
      Valore percentuale di apertura da raggiungere dopo il reset.
      Tipicamente 1%.
    default: 1
    selector:
      number:
        min: 1
        max: 5
        step: 1

  tilt_up_apply_when_below:
    name: Applica Tilt-UP solo se target < (%)
    description: >
      Se >0, tilt-up viene applicato solo quando la posizione calcolata
      Ã¨ inferiore a questa soglia. Imposta 0 per applicarlo sempre.
    default: 0
    selector:
      number:
        min: 0
        max: 100
        step: 1

  tilt_up_reset_delay:
    name: Ritardo reset Tilt-UP (secondi)
    description: >
      Tempo tra la chiusura completa e la successiva apertura al tilt.
      Regolabile in base ai motori BTicino.
    default: 1
    selector:
      number:
        min: 0.2
        max: 5
        step: 0.1

  ###########################################
  # 5. TILT-DOWN (OMBREGGIATURA ALTA)      #
  ###########################################
  tilt_down_enabled:
    name: Abilita Tilt-DOWN
    description: >
      Se attivo, applica un offset verso il basso alla posizione calcolata,
      utile per creare ombreggiatura alta.
    default: true
    selector:
      boolean: {}

  tilt_down_offset:
    name: Offset Tilt-DOWN (%)
    description: >
      Percentuale da sottrarre alla posizione calcolata (es. 20 â†’ 19).
      Tipico: 1â€“2%.
    default: 1
    selector:
      number:
        min: 1
        max: 5
        step: 1

  ###########################################
  # 6. MODALITÃ€ CLIMATICA (FACOLTATIVA)     #
  ###########################################
  climate_enabled:
    name: Abilita modalitÃ  climatica
    description: >
      Attiva logiche aggiuntive su temperatura interna, pioggia, vento,
      presenza, porta aperta.
    default: false
    selector:
      boolean: {}

  rain_sensor:
    name: Sensore pioggia (opzionale)
    description: >
      Sensore tipo binary_sensor che indica presenza di pioggia.
    selector:
      entity:
        domain: binary_sensor

  rain_action:
    name: Azione pioggia
    description: >
      Comportamento quando il sensore pioggia Ã¨ ON.
    default: chiudi_tutto
    selector:
      select:
        options:
          - label: Chiudi tutto
            value: chiudi_tutto
          - label: Solo privacy
            value: solo_privacy
          - label: Ignora pioggia
            value: ignora

  wind_sensor:
    name: Sensore vento (opzionale)
    description: >
      Sensore vento (numeric). Se supera una soglia evita aperture.
    selector:
      entity:
        domain: sensor

  wind_threshold:
    name: Soglia vento
    description: >
      Se il sensore vento supera questa soglia, l'apertura viene limitata.
    default: 0
    selector:
      number:
        min: 0
        max: 100
        step: 1

  temp_sensor_inside:
    name: Sensore temperatura interna (opzionale)
    description: >
      Sensore temperatura interna per logiche climatiche. 
    selector:
      entity:
        domain: sensor

  temp_hot_threshold:
    name: Soglia caldo (Â°C)
    description: >
      Se temperatura interna > soglia e absence â†’ maggiore ombreggiatura.
    default: 27
    selector:
      number:
        min: -10
        max: 50
        step: 0.5

  temp_cold_threshold:
    name: Soglia freddo (Â°C)
    description: >
      Se temperatura interna < soglia â†’ piÃ¹ apertura per guadagno solare.
    default: 18
    selector:
      number:
        min: -10
        max: 50
        step: 0.5

  presence_sensor:
    name: Sensore presenza (opzionale)
    description: >
      Sensore di movimento o presenza. Usato per logiche climatiche.
    selector:
      entity:
        domain: binary_sensor

  presence_timeout:
    name: Timeout assenza (minuti)
    description: >
      Tempo dopo l'ultimo evento di presenza per considerare assenza persona.
    default: 30
    selector:
      number:
        min: 0
        max: 1440
        step: 1

  door_sensor:
    name: Sensore porta finestra (opzionale)
    description: >
      Se la porta Ã¨ aperta puÃ² alterare la logica: chiudi, privacy, ignora.
    selector:
      entity:
        domain: binary_sensor

  door_behavior:
    name: Comportamento porta aperta
    description: >
      Regole quando viene rilevata porta aperta (se configurata).
    default: keep
    selector:
      select:
        options:
          - label: Mantieni posizione attuale
            value: keep
          - label: Chiudi tutto
            value: chiudi_tutto
          - label: Solo privacy
            value: solo_privacy

  ###########################################
  # 7. OVERRIDE MANUALE                     #
  ###########################################
  manual_override_entity:
    name: Override manuale (opzionale)
    description: >
      Un input_boolean che, se ON, blocca tutti i movimenti automatici.
    selector:
      entity:
        domain: input_boolean

  override_time:
    name: Durata override (minuti)
    description: >
      Se override manuale Ã¨ attivo, sospende l'automazione per questo tempo.
    default: 30
    selector:
      number:
        min: 1
        max: 1440
        step: 1

  ###########################################
  # 8. DEBUG                                #
  ###########################################
  debug:
    name: Debug log
    description: >
      Se abilitato, scrive log dettagliati per troubleshooting.
    default: false
    selector:
      boolean: {}
###########################################
#   B L O C C O   2 :   V A R I A B I L I  #
###########################################

variables:

  cover: !input cover_entity
  azimut: !input azimut
  fov: !input fov
  fov_left: !input fov_left
  fov_right: !input fov_right
  distance: !input distance
  max_height: !input max_height
  default_position: !input default_position
  min_position: !input min_position
  min_elevation: !input min_elevation
  max_elevation: !input max_elevation
  change_threshold: !input change_threshold
  cooldown_minutes: !input cooldown_minutes

  privacy_mode: !input privacy_mode
  privacy_min_position: !input privacy_min_position
  privacy_threshold: !input privacy_threshold

  tilt_up_enabled: !input tilt_up_enabled
  tilt_up_position: !input tilt_up_position
  tilt_up_apply_when_below: !input tilt_up_apply_when_below
  tilt_up_reset_delay: !input tilt_up_reset_delay

  tilt_down_enabled: !input tilt_down_enabled
  tilt_down_offset: !input tilt_down_offset

  climate_enabled: !input climate_enabled
  rain_sensor: !input rain_sensor
  rain_action: !input rain_action
  wind_sensor: !input wind_sensor
  wind_threshold: !input wind_threshold
  temp_sensor_inside: !input temp_sensor_inside
  temp_hot_threshold: !input temp_hot_threshold
  temp_cold_threshold: !input temp_cold_threshold
  presence_sensor: !input presence_sensor
  presence_timeout: !input presence_timeout
  door_sensor: !input door_sensor
  door_behavior: !input door_behavior

  manual_override: !input manual_override_entity
  override_time: !input override_time

  debug: !input debug

  #######################################
  #   CALCOLO POSIZIONE SOLE            #
  #######################################
  sun_azimuth: "{{ state_attr('sun.sun', 'azimuth') }}"
  sun_elevation: "{{ state_attr('sun.sun', 'elevation') }}"

  gamma_rad: >
    {% set a = (azimut - sun_azimuth + 180) % 360 - 180 %}
    {{ a * pi / 180 }}

  fov_left_rad: "{{ (fov_left * pi / 180) }}"
  fov_right_rad: "{{ (fov_right * pi / 180) }}"
  elev_min_rad: "{{ (min_elevation * pi / 180) }}"
  elev_max_rad: "{{ (max_elevation * pi / 180) }}"
  sun_elev_rad: "{{ sun_elevation * pi / 180 }}"

  #######################################
  #   SOLE DENTRO FOV? (TRUE/FALSE)     #
  #######################################
  sun_in_fov: >
    {{ gamma_rad >= -fov_left_rad and gamma_rad <= fov_right_rad
       and sun_elev_rad >= elev_min_rad
       and sun_elev_rad <= elev_max_rad }}

  #######################################
  #    CALCOLO OMBRA SU PAVIMENTO       #
  #######################################
  sun_height_m: >
    {% if (sun_elev_rad | float) <= 0 %}
      9999
    {% else %}
      {{ distance / (tan(sun_elev_rad)) }}
    {% endif %}

  position_calc_raw: >
    {% set perc = (sun_height_m / max_height) * 100 %}
    {% if perc < 0 %} 0
    {% elif perc > 100 %} 100
    {% else %} {{ perc }}
    {% endif %}

  #######################################
  #      PRIVACY COMPUTATION            #
  #######################################
  position_after_privacy: >
    {% set p = position_calc_raw | float %}
    {% if privacy_mode == "always" %}
      {{ max(p, privacy_min_position) }}
    {% elif privacy_mode == "sun_in_fov" %}
      {% if sun_in_fov %}
        {{ max(p, privacy_min_position) }}
      {% else %}
        {{ p }}
      {% endif %}
    {% elif privacy_mode == "below_threshold" %}
      {% if p < privacy_threshold %}
        {{ max(p, privacy_min_position) }}
      {% else %}
        {{ p }}
      {% endif %}
    {% else %}
      {{ p }}
    {% endif %}

  #######################################
  #          TILT-DOWN OFFSET           #
  #######################################
  position_after_tilt_down: >
    {% set p = position_after_privacy | float %}
    {% if tilt_down_enabled %}
      {{ max(0, p - tilt_down_offset) }}
    {% else %}
      {{ p }}
    {% endif %}

  #######################################
  #     POSIZIONE FINALE PRELIMINARE    #
  #######################################
  position_target_pre: >
    {% if sun_in_fov %}
      {{ position_after_tilt_down }}
    {% else %}
      {{ default_position }}
    {% endif %}

  #######################################
  #   APPLICO POSIZIONE MINIMA ASSOLUTA #
  #######################################
  position_target: >
    {% set p = position_target_pre | float %}
    {% if p < min_position %}
      {{ min_position }}
    {% else %}
      {{ p }}
    {% endif %}

###########################################
#   B L O C C O   3 :  T R I G G E R      #
###########################################

trigger:
  - platform: state
    entity_id: sun.sun

  - platform: time_pattern
    minutes: "/1"   # backup ogni minuto

###########################################
#   B L O C C O   4 :  C O N D I T I O N #
###########################################

condition:

  # Se override manuale Ã¨ attivo â†’ STOP
  - condition: template
    value_template: >
      {% if manual_override %}
        {{ is_state(manual_override, 'off') }}
      {% else %}
        true
      {% endif %}

  # Cooldown (evita stress motori)
  - condition: template
    value_template: >
      {% set last = states[cover.entity_id].last_changed %}
      {{ (now() - last).total_seconds() / 60 >= cooldown_minutes }}
###########################################
#   B L O C C O   5 :   A Z I O N I       #
###########################################

action:

  ##################################
  # 1) DEBUG : STAMPA VALORI       #
  ##################################
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ debug }}"
        sequence:
          - service: system_log.write
            data:
              message: >
                [FRANGISOLE DEBUG]  
                Sole in FOV: {{ sun_in_fov }}  
                Elevazione: {{ sun_elevation }}  
                Azimut: {{ sun_azimuth }}  
                Calcolo ombra: {{ position_calc_raw }}%  
                Privacy â†’ {{ position_after_privacy }}%  
                Tilt-down â†’ {{ position_after_tilt_down }}%  
                Target finale â†’ {{ position_target }}%
              level: info


  ##################################
  # 2) LOGICA CLIMATICA BASE       #
  ##################################

  - choose:

      ##########################################################
      # â˜” PIOGGIA â€” solo se abilitato
      ##########################################################
      - conditions:
          - condition: template
            value_template: "{{ climate_enabled and rain_sensor != none }}"
          - condition: state
            entity_id: !input rain_sensor
            state: "on"
        sequence:

          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: >
                {% if rain_action == "close" %} 0
                {% elif rain_action == "open" %} 100
                {% else %} {{ position_target }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: "[FRANGISOLE] Rain mode attivato"
                      level: info

          - stop


      ##########################################################
      # ðŸ’¨ VENTO â€” se supera la soglia (protezione frangisole)
      ##########################################################
      - conditions:
          - condition: template
            value_template: "{{ climate_enabled and wind_sensor != none }}"
          - condition: template
            value_template: >
              {{ states(wind_sensor)|float(0) >= wind_threshold }}
        sequence:
          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: 100   # tutto aperto = sicuro

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: "[FRANGISOLE] Wind mode attivato"
                      level: warning

          - stop


      ##########################################################
      # ðŸšª PORTA APERTA (se configurato)
      ##########################################################
      - conditions:
          - condition: template
            value_template: "{{ climate_enabled and door_sensor != none }}"
          - condition: state
            entity_id: !input door_sensor
            state: "on"
        sequence:

          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: >
                {% if door_behavior == "open_full" %} 100
                {% elif door_behavior == "close_full" %} 0
                {% else %} {{ position_target }}
                {% endif %}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: "[FRANGISOLE] Door mode attivato"
                      level: info

          - stop


  ##################################
  # 3) MOVIMENTO PRINCIPALE        #
  ##################################

  - service: cover.set_cover_position
    target: !input cover_entity
    data:
      position: "{{ position_target | int }}"


  ##################################
  # 4) TILT-UP DOPO MOVIMENTO      #
  ##################################

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ tilt_up_enabled }}"
          - condition: template
            value_template: >
              {% set t = position_target|float %}
              {% set thr = tilt_up_apply_when_below|float %}
              {{ t <= thr }}
        sequence:

          - delay:
              seconds: "{{ tilt_up_reset_delay }}"

          - service: cover.set_cover_position
            target: !input cover_entity
            data:
              position: "{{ tilt_up_position }}"   # â†’ 1â€“5% (INCLINAZIONE LAMELLE)

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: >
                        [FRANGISOLE] Tilt-UP applicato dopo movimento
                      level: info

###########################################
#   F I N E   B L U E P R I N T           #
###########################################

mode: restart
